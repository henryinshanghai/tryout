è¿™æ˜¯ä¸€ä¸ªéå¸¸å…³é”®çš„é—®é¢˜ï¼ç­”æ¡ˆæ˜¯ï¼š
ä¸ä¸€å®šã€‚
ObjectFactory åˆ›å»ºå‡ºçš„å¯¹è±¡ å¯èƒ½æ˜¯åŸå§‹å¯¹è±¡ï¼Œä¹Ÿå¯èƒ½æ˜¯ä»£ç†å¯¹è±¡ï¼Œ
å–å†³äºè¯¥ Bean æ˜¯å¦éœ€è¦ Spring AOP å¢å¼ºï¼ˆå¦‚ @Transactionalã€@Async ç­‰ï¼‰ã€‚

===
ğŸ” ä¸€ã€å…ˆçœ‹ ObjectFactory åœ¨ä¸‰çº§ç¼“å­˜ä¸­æ˜¯ æ€ä¹ˆç”¨çš„
åœ¨ Spring åˆ›å»º Bean çš„æ—©æœŸé˜¶æ®µï¼ˆå®ä¾‹åŒ–åã€åˆå§‹åŒ–å‰ï¼‰ï¼Œä¼šå°†ä¸€ä¸ª ObjectFactory æ”¾å…¥ä¸‰çº§ç¼“å­˜ï¼š
    // ä¼ªä»£ç ï¼šSpring å†…éƒ¨é€»è¾‘
    addSingletonFactory(beanName, () -> getEarlyBeanReference(beanName, beanInstance));
å…¶ä¸­ï¼š
â‘  beanInstance æ˜¯åˆšé€šè¿‡ æ„é€ å‡½æ•° åˆ›å»ºçš„ åŸå§‹å¯¹è±¡ï¼ˆraw objectï¼‰
â‘¡ getEarlyBeanReference(...) æ˜¯å…³é”®æ–¹æ³•ï¼Œå®ƒå†³å®š è¿”å›ä»€ä¹ˆ

===
ğŸ§© äºŒã€getEarlyBeanReference åšäº†ä»€ä¹ˆï¼Ÿ
è¿™ä¸ªæ–¹æ³• ä¼šéå† æ‰€æœ‰æ³¨å†Œçš„ SmartInstantiationAwareBeanPostProcessor
ï¼ˆä¸»è¦æ˜¯ AbstractAutoProxyCreatorï¼Œå³ AOP ä»£ç†åˆ›å»ºå™¨ï¼‰ï¼š

    protected Object getEarlyBeanReference(String beanName, Object bean) {
        Object exposedObject = bean;

        for (BeanPostProcessor bp : getBeanPostProcessors()) {
            if (bp instanceof SmartInstantiationAwareBeanPostProcessor) {

                SmartInstantiationAwareBeanPostProcessor sip =
                    (SmartInstantiationAwareBeanPostProcessor) bp;

                // å…³é”®ï¼šè°ƒç”¨ getEarlyBeanReference
                exposedObject = sip.getEarlyBeanReference(exposed)))) ;
            }
        }
        return exposedObject;
    }
âœ… æ ¸å¿ƒé€»è¾‘ï¼š
â‘  å¦‚æœ æ²¡æœ‰ä»»ä½• AOP åˆ‡é¢åŒ¹é…è¯¥ Bean â†’ è¿”å› åŸå§‹å¯¹è±¡
â‘¡ å¦‚æœ æœ‰ AOP åˆ‡é¢ï¼ˆå¦‚ @Transactionalï¼‰ â†’ è¿”å› ä»£ç†å¯¹è±¡

===
ğŸ“Œ ä¸‰ã€ä¸¤ç§æƒ…å†µå¯¹æ¯”
æƒ…å†µ 1ï¸âƒ£ï¼šBean ä¸éœ€è¦ AOP ä»£ç†ï¼ˆæ™®é€š Beanï¼‰
    @Service
    public class OrderService {
        public void createOrder() { ... }
    }

â‘  ObjectFactory.getObject() â†’ è¿”å› åŸå§‹å¯¹è±¡ orderService
â‘¡ æœ€ç»ˆ æ”¾å…¥ä¸€çº§ç¼“å­˜çš„ ä¹Ÿæ˜¯ åŒä¸€ä¸ªåŸå§‹å¯¹è±¡
â‘¢ âœ… æ˜¯åŒä¸€ä¸ªå¯¹è±¡

æƒ…å†µ 2ï¸âƒ£ï¼šBean éœ€è¦ AOP ä»£ç†ï¼ˆå¦‚å¸¦ @Transactionalï¼‰
    @Service
    @Transactional
    public class OrderService {
        public void createOrder() { ... }
    }
â‘  ObjectFactory.getObject() â†’ è°ƒç”¨ getEarlyBeanReference â†’ åˆ›å»º ä»£ç†å¯¹è±¡ orderServiceProxy
â‘¡ æœ€ç»ˆ æ”¾å…¥ä¸€çº§ç¼“å­˜çš„ ä¹Ÿæ˜¯ è¿™ä¸ªä»£ç†å¯¹è±¡
â‘¢ âœ… ä»ç„¶æ˜¯ åŒä¸€ä¸ªå¯¹è±¡ï¼ˆB æ‹¿åˆ°çš„æ˜¯ ä»£ç†ï¼Œå®¹å™¨ æœ€ç»ˆå­˜çš„ ä¹Ÿæ˜¯è¿™ä¸ªä»£ç†ï¼‰
ğŸ’¡ æ³¨æ„ï¼šè™½ç„¶ ä»£ç† å†…éƒ¨æŒæœ‰ å¯¹åŸå§‹å¯¹è±¡çš„å¼•ç”¨ï¼Œä½† ObjectFactory è¿”å›çš„æ˜¯ ä»£ç†æœ¬èº«ï¼Œä¸æ˜¯ åŸå§‹å¯¹è±¡ã€‚

===
â— å››ã€ä¸ºä»€ä¹ˆå¼ºè°ƒâ€œåŒä¸€ä¸ªå¯¹è±¡â€ï¼Ÿ
è¿™æ˜¯ä¸ºäº†ä¿è¯ å¯¹è±¡ä¸€è‡´æ€§ï¼š
â‘  å¦‚æœ B åœ¨ å¾ªç¯ä¾èµ– ä¸­ æ‹¿åˆ°çš„æ˜¯ åŸå§‹å¯¹è±¡ï¼›
â‘¡ è€Œ å®¹å™¨ æœ€ç»ˆå­˜çš„æ˜¯ ä»£ç†å¯¹è±¡
â‘¢ é‚£ä¹ˆï¼š
    â…  B è°ƒç”¨ orderService.createOrder() â†’ ä¸èµ°äº‹åŠ¡ï¼
    â…¡ å…¶ä»–åœ°æ–¹è°ƒç”¨ â†’ èµ°äº‹åŠ¡
â‘£ âš  è¿™å°± ç ´åäº† Spring AOP çš„è¯­ä¹‰ï¼

âœ… ä¸‰çº§ç¼“å­˜ + ObjectFactory çš„è®¾è®¡ï¼Œç¡®ä¿ï¼š
    æ— è®º æ˜¯å¦å‘ç”Ÿ å¾ªç¯ä¾èµ–ï¼Œæ‰€æœ‰åœ°æ–¹ ä½¿ç”¨çš„ éƒ½æ˜¯ åŒä¸€ä¸ªå¯¹è±¡ï¼ˆåŸå§‹ or ä»£ç†ï¼‰

===
âœ… æ€»ç»“

é—®é¢˜	                                ç­”æ¡ˆ
ObjectFactory è¿”å›çš„æ˜¯ åŸå§‹å¯¹è±¡å—ï¼Ÿ	ä¸ä¸€å®š
ä»€ä¹ˆæ—¶å€™ è¿”å› åŸå§‹å¯¹è±¡ï¼Ÿ	            Bean ä¸éœ€è¦ AOP ä»£ç† æ—¶
ä»€ä¹ˆæ—¶å€™ è¿”å› ä»£ç†å¯¹è±¡ï¼Ÿ	            Bean éœ€è¦ AOP ä»£ç†ï¼ˆå¦‚ @Transactionalï¼‰æ—¶
å’Œæœ€ç»ˆ å®¹å™¨ä¸­çš„å¯¹è±¡ æ˜¯ åŒä¸€ä¸ªå—ï¼Ÿ	    æ˜¯ï¼ ä¿è¯äº†å¯¹è±¡ä¸€è‡´æ€§
ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ	                    é˜²æ­¢ å¾ªç¯ä¾èµ– å¯¼è‡´ AOP å¤±æ•ˆ

ç†è§£è¿™ä¸€ç‚¹ï¼Œä½ å°±çœŸæ­£æŒæ¡äº† Spring ä¸‰çº§ç¼“å­˜çš„ç²¾é«“ï¼š
å®ƒ ä¸åªæ˜¯ è§£å†³å¾ªç¯ä¾èµ–ï¼Œæ›´æ˜¯ä¿è¯ â€œå¸¦ä»£ç†çš„ Beanâ€ åœ¨ ä»»ä½•åœºæ™¯ ä¸‹éƒ½ è¡Œä¸ºä¸€è‡´ã€‚