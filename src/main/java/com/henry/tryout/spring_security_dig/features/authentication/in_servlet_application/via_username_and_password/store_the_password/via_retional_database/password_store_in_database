Securityâ€™s JdbcDaoImpl å®ç°äº† UserDetailsService
æ¥ æä¾› å¯¹ ä½¿ç”¨JDBCè·å–çš„ username&passwordè®¤è¯æ–¹å¼çš„æ”¯æŒ

JdbcUserDetailsManager ç»§æ‰¿äº† JdbcDaoImpl
æ¥ é€šè¿‡ UserDetailsManageræ¥å£ å®ç° å¯¹ UserDetailsçš„ç®¡ç†

å½“ Security è¢«é…ç½®æˆ æ¥æ”¶username&passwordæ¥è¿›è¡Œè®¤è¯æ—¶ï¼ŒSecurityå°±ä¼šä½¿ç”¨ â€åŸºäºUserDetailsâ€œçš„è®¤è¯æ‰‹æ®µã€‚

æ¥ä¸‹æ¥è®¨è®ºï¼š
#1 Security JDBC Authenticationé»˜è®¤ä½¿ç”¨çš„ Schema
#2 è®¾ç½®æ•°æ®æºï¼›
#3 JdbcUserDetailsManager Beanå®ä¾‹ï¼›

===
é»˜è®¤çš„Schema

Security ä¸º åŸºäºJDBCçš„è®¤è¯ æä¾›äº†é»˜è®¤æŸ¥è¯¢ï¼›
è¿™ä¸ªéƒ¨åˆ†æä¾›äº† é»˜è®¤æŸ¥è¯¢å¯¹åº”çš„é»˜è®¤Schemaã€‚
å¼€å‘è€… éœ€è¦è°ƒæ•´schema æ¥ åŒ¹é…å¯¹æŸ¥è¯¢åšå‡ºçš„å®šåˆ¶åŒ– ä»¥åŠ å¼€å‘è€…æ‰€ä½¿ç”¨çš„æ•°æ®åº“æ–¹è¨€

#1 åå­—å«åš Userçš„ schema:
JdbcDaoImpl éœ€è¦æ•°æ®è¡¨ æ¥ åŠ è½½å¯†ç ã€è´¦å·çŠ¶æ€ï¼ˆå¼€å¯æˆ–ç¦ç”¨ï¼‰ä»¥åŠuserçš„ä¸€å †æƒé™ï¼ˆè§’è‰²ï¼‰ï¼›
ğŸ– é»˜è®¤çš„schema ä¹Ÿä¼šé€šè¿‡ ä¸€ä¸ªåå­—å«åš org/springframework/security/core/userdetails/jdbc/users.ddl çš„classpathèµ„æº æš´éœ²å‡ºæ¥

--- é»˜è®¤æä¾›çš„schema ---
create table users(
	username varchar_ignorecase(50) not null primary key,
	password varchar_ignorecase(500) not null,
	enabled boolean not null
);

create table authorities (
	username varchar_ignorecase(50) not null,
	authority varchar_ignorecase(50) not null,
	constraint fk_authorities_users foreign key(username) references users(username)
);
create unique index ix_auth_username on authorities (username,authority);

--- ä½¿ç”¨Oracleæ•°æ®åº“æ—¶çš„User Schemaï¼ˆéœ€è¦ä¸€äº›è°ƒæ•´ï¼‰ ---
CREATE TABLE USERS (
    USERNAME NVARCHAR2(128) PRIMARY KEY,
    PASSWORD NVARCHAR2(128) NOT NULL,
    ENABLED CHAR(1) CHECK (ENABLED IN ('Y','N') ) NOT NULL
);


CREATE TABLE AUTHORITIES (
    USERNAME NVARCHAR2(128) NOT NULL,
    AUTHORITY NVARCHAR2(128) NOT NULL
);
ALTER TABLE AUTHORITIES ADD CONSTRAINT AUTHORITIES_UNIQUE UNIQUE (USERNAME, AUTHORITY);
ALTER TABLE AUTHORITIES ADD CONSTRAINT AUTHORITIES_FK1 FOREIGN KEY (USERNAME) REFERENCES USERS (USERNAME) ENABLE;

#2 åå­—å«åš Groupçš„Schemaï¼š
å¦‚æœä½ çš„åº”ç”¨ç¨‹åºä½¿ç”¨äº† Groupï¼Œé‚£ä½ å°±éœ€è¦æä¾› groups shcemaã€‚

--- é»˜è®¤æä¾›çš„ Group Schema ---
create table groups (
	id bigint generated by default as identity(start with 0) primary key,
	group_name varchar_ignorecase(50) not null
);

create table group_authorities (
	group_id bigint not null,
	authority varchar(50) not null,
	constraint fk_group_authorities_group foreign key(group_id) references groups(id)
);

create table group_members (
	id bigint generated by default as identity(start with 0) primary key,
	username varchar(50) not null,
	group_id bigint not null,
	constraint fk_group_members_group foreign key(group_id) references groups(id)
);

===
è®¾ç½®æ•°æ®æº
åœ¨é…ç½® JdbcUserDetailsManagerä¹‹å‰ï¼Œéœ€è¦å…ˆåˆ›å»ºä¸€ä¸ª DataSource
è¿™é‡Œï¼Œæˆ‘ä»¬è®¾ç½®äº†ä¸€ä¸ª ä½¿ç”¨é»˜è®¤çš„user schema æ¥åˆå§‹åŒ–çš„ å†…åµŒçš„ DataSource

@Bean
DataSource dataSource() {
	return new EmbeddedDatabaseBuilder()
		.setType(H2)
		.addScript(JdbcDaoImpl.DEFAULT_USER_SCHEMA_DDL_LOCATION)
		.build();
}

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä½ éœ€è¦è®¾ç½®ä¸€ä¸ª åˆ°å¤–éƒ¨æ•°æ®åº“çš„è¿æ¥ï¼›

===
JdbcUserDetailsManager Beanå®ä¾‹

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Spring Boot CLI æ¥ ç¼–ç ä¸€ä¸ªpasswordçš„å€¼
å¹¶ è·å–ç¼–ç åçš„å¯†ç  {bcrypt}$2a$10$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW

@Bean
UserDetailsManager users(DataSource dataSource) {
	UserDetails user = User.builder()
		.username("user")
		.password("{bcrypt}$2a$10$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW")
		.roles("USER")
		.build();
	UserDetails admin = User.builder()
		.username("admin")
		.password("{bcrypt}$2a$10$GRLdNijSQMUvl/au9ofL.eDwmoohzzS7.rmNSJZ.0FxO/BTk76klW")
		.roles("USER", "ADMIN")
		.build();
	JdbcUserDetailsManager users = new JdbcUserDetailsManager(dataSource);
	users.createUser(user);
	users.createUser(admin);
	return users;
}