ThreadLocalå®ä¾‹ä¸­å…·ä½“åŒ…å«äº†ä»€ä¹ˆ?
ThreadLocalå¯¹è±¡ ä¸ å…¶å†…éƒ¨mapä¸­çš„key æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ
keyç©¶ç«Ÿå¼±å¼•ç”¨äº†è°?

===
ä¸€ã€ThreadLocal å®ä¾‹ä¸­ å…·ä½“åŒ…å«äº† ä»€ä¹ˆï¼Ÿ
ç­”æ¡ˆï¼šå‡ ä¹ä»€ä¹ˆä¹Ÿä¸åŒ…å«ï¼

ThreadLocal æœ¬èº«æ˜¯ä¸€ä¸ª è½»é‡çº§çš„â€œæ ‡è¯†ç¬¦â€æˆ–â€œé’¥åŒ™â€ï¼Œå®ƒçš„æºç  éå¸¸ç®€å•ï¼ˆJDK 8ï¼‰ï¼š

public class ThreadLocal<T> {
    // æ¯ä¸ª ThreadLocalå®ä¾‹ æœ‰ä¸€ä¸ª å”¯ä¸€çš„ IDï¼ˆç”¨äºå“ˆå¸Œï¼‰
    private final int threadLocalHashCode = nextHashCode();

    // æ„é€ å‡½æ•°æ˜¯ ç©ºçš„
    public ThreadLocal() { }

    // æ ¸å¿ƒæ–¹æ³•ï¼šset / get / remove
    public void set(T value) { /* ... */ }
    public T get() { /* ... */ }
    public void remove() { /* ... */ }

    // ...
}

âœ… å…³é”®ç‚¹ï¼š
â‘  ThreadLocal ä¸å­˜å‚¨ ä»»ä½•ç”¨æˆ·æ•°æ®ï¼ˆvalueï¼‰ã€‚
â‘¡ å®ƒ åªåŒ…å«ä¸€ä¸ª ç”¨äºå“ˆå¸Œçš„ threadLocalHashCodeï¼ˆç”¨äº åœ¨ ThreadLocalMap ä¸­ å®šä½ä½ç½®ï¼‰ã€‚
â‘¢ å®ƒçš„ä½œç”¨æ˜¯ï¼šä½œä¸º keyï¼Œå» å½“å‰çº¿ç¨‹çš„ ThreadLocalMap ä¸­ æŸ¥æ‰¾æˆ–è®¾ç½® å¯¹åº”çš„valueã€‚
ğŸ§  ç±»æ¯”ï¼šThreadLocal å°±åƒä¸€æŠŠâ€œå¸¦ç¼–å·çš„é’¥åŒ™â€ï¼Œå®ƒè‡ªå·± ä¸è£…ä¸œè¥¿ï¼Œä½† èƒ½æ‰“å¼€ çº¿ç¨‹ç§æœ‰å‚¨ç‰©æŸœï¼ˆThreadLocalMapï¼‰é‡Œçš„æŸä¸ªæ ¼å­ã€‚

===
äºŒã€ThreadLocal å¯¹è±¡ ä¸ ThreadLocalMapä¸­çš„key æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ
ç­”æ¡ˆï¼šå®ƒä»¬æ˜¯ åŒä¸€ä¸ªå¯¹è±¡ï¼

å½“ä½ æ‰§è¡Œï¼š
    ThreadLocal<String> tl = new ThreadLocal<>();
    tl.set("hello");

åº•å±‚å®é™…å‘ç”Ÿçš„æ˜¯ï¼š
    // åœ¨ ThreadLocal.set() æ–¹æ³•å†…éƒ¨ï¼š
    Thread t = Thread.currentThread();
    ThreadLocalMap map = t.threadLocals;
    if (map != null)
        map.set(this, value); // â† æ³¨æ„ï¼šthis å°±æ˜¯ tl æœ¬èº«ï¼

æ‰€ä»¥ï¼š
â‘  ThreadLocalMap çš„ key å°±æ˜¯ ThreadLocal å®ä¾‹æœ¬èº«ï¼ˆå³ tl è¿™ä¸ªå¯¹è±¡ï¼‰ã€‚
â‘¡ æ¢å¥è¯è¯´ï¼štl æ—¢æ˜¯ ä½ çš„ä»£ç ä¸­ æŒæœ‰çš„å˜é‡ï¼Œä¹Ÿæ˜¯ mapä¸­çš„keyã€‚

===
ä¸‰ã€key ç©¶ç«Ÿ å¼±å¼•ç”¨äº† è°ï¼Ÿ
ç­”æ¡ˆï¼šå¼±å¼•ç”¨äº† ThreadLocalå®ä¾‹æœ¬èº«ï¼ˆå³ tl å¯¹è±¡ï¼‰
æˆ‘ä»¬å†çœ‹ ThreadLocalMap.Entry çš„å®šä¹‰ï¼š

    static class Entry extends WeakReference<ThreadLocal<?>> {
        Object value;

        Entry(ThreadLocal<?> k, Object v) {
            super(k); // â† è°ƒç”¨ WeakReference çš„æ„é€ å‡½æ•°
            value = v;
        }
    }
â‘  Entry ç»§æ‰¿è‡ª WeakReference<ThreadLocal<?>>ã€‚
â‘¡ super(k) è¡¨ç¤ºï¼šè¿™ä¸ªWeakReference æŒ‡å‘çš„æ˜¯ ä¼ å…¥çš„kï¼Œä¹Ÿå°±æ˜¯ ThreadLocalå®ä¾‹ã€‚
â‘¢ å› æ­¤ï¼Œkey æ˜¯ å¯¹ ThreadLocalå¯¹è±¡çš„ å¼±å¼•ç”¨ã€‚

ä¸¾ä¸ªå…·ä½“ä¾‹å­ï¼š
    void someMethod() {
        ThreadLocal<String> tl = new ThreadLocal<>(); // tl æ˜¯ å±€éƒ¨å˜é‡ï¼ˆå¼ºå¼•ç”¨ï¼‰
        tl.set("data");
        // æ–¹æ³•ç»“æŸï¼Œtl å˜é‡ å‡ºä½œç”¨åŸŸ â†’ å¼ºå¼•ç”¨ æ¶ˆå¤±
    }

æ­¤æ—¶ï¼š
â‘  å †ä¸­ å­˜åœ¨ä¸€ä¸ª ThreadLocal å¯¹è±¡ï¼ˆæˆ‘ä»¬å«å®ƒ TL-Objï¼‰ã€‚
â‘¡ ThreadLocalMap ä¸­æœ‰ä¸€ä¸ª Entryï¼Œå…¶ key æ˜¯ WeakReference<TL-Obj>ã€‚
â‘¢ æ–¹æ³•ç»“æŸåï¼Œåªæœ‰ è¿™ä¸ªå¼±å¼•ç”¨ æŒ‡å‘ TL-Objã€‚
â‘£ ä¸‹æ¬¡ GC æ—¶ï¼ŒTL-Obj ä¼š è¢«å›æ”¶ â†’ Entry.getKey() è¿”å› nullã€‚
âœ… æ‰€ä»¥ï¼šå¼±å¼•ç”¨çš„å¯¹è±¡ = ä½ åˆ›å»ºçš„é‚£ä¸ª ThreadLocal å®ä¾‹æœ¬èº«ã€‚

===
å››ã€å›¾è§£å…³ç³»
ä½ çš„ä»£ç ï¼š
  ThreadLocal<String> tl = new ThreadLocal<>();   â† tl æ˜¯å¼ºå¼•ç”¨ï¼ˆæ ˆä¸Šï¼‰

å †å†…å­˜ï¼š
  [TL-Obj]  â† ThreadLocal å®ä¾‹ï¼ˆheap objectï¼‰
      â”‚
      â”‚ (è¢« tl å¼ºå¼•ç”¨ï¼Œä¹Ÿ è¢« Entryå¼±å¼•ç”¨)
      â–¼

Thread.currentThread():
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Thread        â”‚
  â”‚               â”‚
  â”‚ threadLocals â”€â”¼â”€â”€â”€â–º [ThreadLocalMap]
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
                             â–¼
                     [Entry]
                         â”‚
                         â”œâ”€â”€ key â”€â”€(WeakReference)â”€â”€â”€â”
                         â”‚                          â”‚
                         â””â”€â”€ value = "data"         â”‚
                                                    â”‚
                    (WeakReference æŒ‡å‘ TL-Obj) â—„â”€â”€â”€â”€â”˜
å½“ tl å˜é‡æ¶ˆå¤±ï¼ˆæ–¹æ³•ç»“æŸï¼‰ï¼ŒTL-Obj åªå‰©å¼±å¼•ç”¨ â†’ å¯è¢« GCã€‚

===
äº”ã€ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ
è®¾è®¡	                        | ç›®çš„
key æ˜¯ ThreadLocalå®ä¾‹æœ¬èº«	| æ¯ä¸ª ThreadLocal å¯¹è±¡å¤©ç„¶å”¯ä¸€ï¼Œå¯ç›´æ¥ä½œä¸º key
key ä½¿ç”¨å¼±å¼•ç”¨	            | é˜²æ­¢ ThreadLocalå®ä¾‹ å›  è¢«mapå¼ºå¼•ç”¨ è€Œ æ— æ³•å›æ”¶ï¼ˆé¿å… ClassLoader æ³„æ¼ç­‰ï¼‰
value æ˜¯å¼ºå¼•ç”¨	            | ä¿è¯ åœ¨ ä½¿ç”¨æœŸé—´ï¼Œvalue ä¸è¢« GC æ‰

ä½†å‰¯ä½œç”¨æ˜¯ï¼šå¦‚æœ value å¾ˆå¤§ï¼Œä¸”å¿˜è®° remove()ï¼Œå³ä½¿ ThreadLocal è¢«å›æ”¶ï¼Œvalue ä»ä¼šæ³„æ¼ã€‚

===
å…­ã€å¸¸è§è¯¯è§£æ¾„æ¸…
âŒ è¯¯è§£1ï¼š â€œThreadLocal é‡Œé¢æœ‰ä¸ª map å­˜æ•°æ®ã€‚â€
âœ… æ­£ç¡®ï¼šæ•°æ® å­˜åœ¨ çº¿ç¨‹å¯¹è±¡çš„ threadLocals å­—æ®µé‡Œï¼Œè€Œä¸æ˜¯ ThreadLocal è‡ªå·±ã€‚

âŒ è¯¯è§£2ï¼š â€œå¼±å¼•ç”¨çš„æ˜¯ valueã€‚â€
âœ… æ­£ç¡®ï¼šå¼±å¼•ç”¨çš„æ˜¯ ThreadLocalå®ä¾‹ï¼ˆkeyï¼‰ï¼Œvalue æ˜¯å¼ºå¼•ç”¨ã€‚

âŒ è¯¯è§£3ï¼š â€œåªè¦ key æ˜¯å¼±å¼•ç”¨ï¼Œå°±ä¸ä¼šå†…å­˜æ³„æ¼ã€‚â€
âœ… æ­£ç¡®ï¼švalue ä»å¯èƒ½æ³„æ¼ï¼Œå¿…é¡»æ‰‹åŠ¨ remove()ã€‚

===
æ€»ç»“
é—®é¢˜	                            | ç­”æ¡ˆ
ThreadLocal å®ä¾‹åŒ…å«ä»€ä¹ˆï¼Ÿ	    | å‡ ä¹ nothingï¼Œåªæœ‰ threadLocalHashCode
ThreadLocal ä¸ map ä¸­çš„ key å…³ç³»ï¼Ÿ| æ˜¯åŒä¸€ä¸ªå¯¹è±¡
key å¼±å¼•ç”¨äº†è°ï¼Ÿ	                | å¼±å¼•ç”¨äº† ThreadLocal å®ä¾‹æœ¬èº«
æ•°æ®å­˜åœ¨å“ªï¼Ÿ	                    | å­˜åœ¨ å½“å‰çº¿ç¨‹çš„ ThreadLocalMap ä¸­
å¦‚ä½•é¿å…æ³„æ¼ï¼Ÿ	                | ç”¨å®ŒåŠ¡å¿…è°ƒç”¨ remove()