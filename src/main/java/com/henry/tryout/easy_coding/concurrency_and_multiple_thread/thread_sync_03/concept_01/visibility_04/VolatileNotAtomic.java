package com.henry.tryout.easy_coding.concurrency_and_multiple_thread.thread_sync_03.concept_01.visibility_04;

// éªŒè¯ï¼šä½¿ç”¨ volatile ä¿®é¥° å˜é‡, æ— æ³•ä¿è¯ è¯¥å˜é‡æ“ä½œçš„åŸå­æ€§
// æ‰‹æ®µï¼šå¯¹ä¸€ä¸ª ç”±volatileä¿®é¥°çš„å˜é‡ï¼Œä¸»çº¿ç¨‹ æ‰§è¡Œ++çš„æ“ä½œï¼Œå­çº¿ç¨‹æ‰§è¡Œ--çš„æ“ä½œï¼ŒæŸ¥çœ‹æœ€ç»ˆå˜é‡çš„å€¼
// åŸç†ï¼šå¦‚æœ å¯¹countçš„æ“ä½œ å…·æœ‰åŸå­æ€§ï¼Œé‚£ä¹ˆ countçš„æœ€ç»ˆå€¼ åº”è¯¥æ˜¯ 0
// ç»“è®ºï¼šåªæœ‰åœ¨ ä¸ºä¸´ç•ŒåŒºåŠ é” åï¼Œæ‰èƒ½å¾—åˆ° é¢„æœŸçš„ç»“æœ(åŠ é” ä¸ åŸå­æ€§ä¹‹é—´æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ)
// ğŸ– å¦‚æœNUMBERä¸å¤Ÿå¤§ï¼Œå¯èƒ½æ— æ³•æ¼”ç¤ºå‡º volatileä¸å…·å¤‡äº’æ–¥æ€§çš„æ•ˆæœ
public class VolatileNotAtomic {
    // #1 ç”±volatileä¿®é¥°çš„ æˆå‘˜å˜é‡ - ä½œç”¨ï¼šä¿è¯ å¯¹è¯¥å˜é‡çš„æ›´æ–° å¯¹ å¤šä¸ªçº¿ç¨‹ éƒ½æ˜¯ ç«‹é©¬å¯è§çš„
    private static volatile long count = 0L;
    public static final int NUMBER = 100000;

    public static void main(String[] args) {
        Thread subtractThread = new SubtractThread();
        // è§¦å‘ è‡ªå®šä¹‰çº¿ç¨‹ run()æ–¹æ³•çš„æ‰§è¡Œ - æ‰‹æ®µï¼šçº¿ç¨‹å¯¹è±¡.start()
        subtractThread.start();

        // åœ¨ ä¸»çº¿ç¨‹ ä¸­ï¼ŒæŠŠ countçš„å€¼ ++ 100000æ¬¡
        for (int i = 0; i < NUMBER; i++) {
            // #2 ä¸ºäº†é¿å… å¤šä¸ªçº¿ç¨‹ å¯¹countå†™æ“ä½œ çš„ç›¸äº’è¦†ç›–ï¼Œè¿™é‡Œä½¿ç”¨ synchronizedå…³é”®å­— æ¥ ä¿è¯çº¿ç¨‹ä¹‹é—´æ“ä½œcountçš„äº’æ–¥æ€§
            synchronized (VolatileNotAtomic.class) {
                count++;
            }

//            count++;
        }

        // ç­‰å¾… å‡æ³•çº¿ç¨‹ ç»“æŸ
        // æ‰‹æ®µï¼šå­çº¿ç¨‹å¯¹è±¡ä¸Šè°ƒç”¨isAlive()æ–¹æ³• - å¦‚æœçº¿ç¨‹å·²å¯åŠ¨ ä½†å°šæœªç»ˆæ­¢ï¼Œåˆ™ è¿”å›trueã€‚
        while (subtractThread.isAlive()) {
        }

        System.out.println("countå˜é‡æœ€ç»ˆçš„å€¼ä¸ºï¼š " + count); // é¢„æœŸï¼šcount=0. å®é™…ä¸Šï¼šcountçš„ç»“æœæ˜¯ä¸€ä¸ªéšæœºå€¼
    }

    // è‡ªå®šä¹‰çš„çº¿ç¨‹ç±» - æ‰‹æ®µï¼š extends Thread
    private static class SubtractThread extends Thread {

        // åœ¨run()æ–¹æ³•ä¸­ï¼ŒæŠŠcountçš„å€¼ -- 100000æ¬¡
        public void run() {
            for (int i = 0; i < NUMBER; i++) {
                // å®šä¹‰ä¸´ç•ŒåŒº æ¥ ä¿è¯æ“ä½œçš„äº’æ–¥æ€§ - æ‰‹æ®µï¼šä½¿ç”¨ synchronizedå…³é”®å­— æ¥ ä¿®é¥°ä¸´ç•ŒåŒº
                synchronized (VolatileNotAtomic.class) {
                    count--;
                }

//                count--;
            }
        }
    }
}
/*
    å¦‚æœcount++ ä¸ count-- éƒ½æ˜¯åŸå­æ“ä½œçš„è¯ï¼Œé‚£countæœ€ç»ˆçš„ç»“æœä¸€å®šä¸º0ï¼›
    ä½†æ˜¯ count++ä¸count--å¹¶ä¸æ˜¯åŸå­æ“ä½œï¼›
    æ€ä¹ˆæ‰èƒ½å¾—åˆ° countä¸º0çš„ç»“æœå‘¢ï¼Ÿ
    æ‰‹æ®µï¼šä¸º count++ ä¸ count-- çš„ä»£ç åŠ é”ï¼Œä¿è¯çº¿ç¨‹çš„äº’æ–¥æ€§ã€‚

count++çš„å­—èŠ‚ç æ­¥éª¤ï¼š
    // è¯»å–countçš„å€¼ï¼Œå¹¶å‹å…¥æ“ä½œæ ˆä¸­
    GETSTATIC
    // æŠŠå¸¸é‡1 å‹å…¥æ“ä½œæ ˆé¡¶
    ICONST_1
    // å–å‡ºæœ€é¡¶éƒ¨çš„ä¸¤ä¸ªå…ƒç´ ç›¸åŠ 
    IADD
    // æŠŠåŠ å’Œå¾—åˆ°çš„ç»“æœ èµ‹å€¼ç»™countå˜é‡
    PUTSTATIC
ç»“æœï¼šåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå…¶ä»–çº¿ç¨‹æœ‰è¶³å¤Ÿçš„æ—¶é—´ æ¥ è¦†ç›–å˜é‡çš„å€¼

Java8ä¸­å¼•å…¥çš„æ”¯æŒ count++ä¸ºåŸå­æ“ä½œçš„ç±»å‹ï¼š
    AtomicLong, LongAdder(æ¨èä½¿ç”¨)

ç»“è®ºï¼š
    1 volatileå¹¶ä¸æ˜¯ è½»é‡çº§çš„"åŒæ­¥æ–¹å¼"ã€‚è€Œæ˜¯ è½»é‡çº§çš„ "çº¿ç¨‹æ“ä½œå¯è§æ–¹å¼"ã€‚
    2 volatileå˜é‡åœ¨ å¤šçº¿ç¨‹å¹¶å‘å†™çš„åœºæ™¯ä¸­ï¼Œä¼šå‡ºç° çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚
    3 volatileå˜é‡ åœ¨ä¸€å†™å¤šè¯»çš„å¤šçº¿ç¨‹åœºæ™¯ä¸­ï¼Œä¸ä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚
        åº”ç”¨ï¼š CopyOnWriteArrayList
            ç‰¹å¾ï¼šåœ¨ä¿®æ”¹æ•°æ®çš„æ—¶å€™ï¼Œä¼šï¼š
                1 æŠŠæ•´ä¸ªé›†åˆçš„æ•°æ®å…¨éƒ¨å¤åˆ¶å‡ºæ¥ï¼›
                2 ç„¶åå¯¹å†™æ“ä½œè¿›è¡ŒåŠ é”ï¼›
                3 å†™æ“ä½œå®Œæˆåï¼Œå†ä½¿ç”¨ setArray()æ–¹æ³• æŠŠarrayå˜é‡æŒ‡å‘æ–°çš„é›†åˆã€‚
            volatileçš„ä½œç”¨ï¼š
                1 ä½¿è¯»çº¿ç¨‹èƒ½å¤Ÿç›´æ¥çœ‹åˆ°arrayçš„å˜åŒ– - å› ä¸ºå†™æ“ä½œå®Œæˆåï¼Œç«‹åˆ»å˜é‡çš„å€¼ç«‹åˆ»å¯¹è¯»çº¿ç¨‹å¯è§ï¼›
                2 é¿å…æŒ‡ä»¤é‡æ’ã€‚
 */

