ä»€ä¹ˆå«åš åŒä¸€ä¸ªçº¿ç¨‹ä¸­çš„ä¸åŒæ–¹æ³•å‘¢ï¼Ÿè¿™ä¸ç±»ä¸­çš„ä¸åŒæ–¹æ³•æ˜¯åŒä¸€å›äº‹å—?

===
ä¸€ã€ä»€ä¹ˆæ˜¯â€œåŒä¸€ä¸ªçº¿ç¨‹ä¸­çš„ä¸åŒæ–¹æ³•â€ï¼Ÿ
â€œåŒä¸€ä¸ªçº¿ç¨‹ä¸­çš„ä¸åŒæ–¹æ³•â€ æŒ‡çš„æ˜¯ï¼šåœ¨ åŒä¸€æ¡æ‰§è¡Œè·¯å¾„ï¼ˆå³åŒä¸€ä¸ªçº¿ç¨‹ï¼‰ä¸­ï¼Œä¾æ¬¡ æˆ– åµŒå¥—è°ƒç”¨çš„ å¤šä¸ªæ–¹æ³•ã€‚

è¿™äº›æ–¹æ³•å¯ä»¥å±äºï¼š
    â‘  åŒä¸€ä¸ªç±»
    â‘¡ ä¸åŒç±»
    â‘¢ ç”šè‡³ä¸åŒåŒ…
åªè¦å®ƒä»¬æ˜¯åœ¨ åŒä¸€ä¸ªçº¿ç¨‹ä¸Šä¸‹æ–‡ ä¸­ è¢«è°ƒç”¨çš„ï¼Œå°±å±äº â€œåŒä¸€ä¸ªçº¿ç¨‹ä¸­çš„ä¸åŒæ–¹æ³•â€ã€‚

==
âœ… ä¸¾ä¸ªä¾‹å­ï¼š
    public class ServiceA {
        public void methodA() {
            System.out.println("methodA in thread: " + Thread.currentThread().getName());
            new ServiceB().methodB(); // è°ƒç”¨å¦ä¸€ä¸ªç±»çš„æ–¹æ³•
        }
    }

    public class ServiceB {
        public void methodB() {
            System.out.println("methodB in thread: " + Thread.currentThread().getName());
            Utils.methodC(); // å†è°ƒç”¨å·¥å…·ç±»çš„æ–¹æ³•
        }
    }

    public class Utils {
        public static void methodC() {
            System.out.println("methodC in thread: " + Thread.currentThread().getName());
        }
    }

    // ä¸»ç¨‹åº
    public class Main {
        public static void main(String[] args) {
            new ServiceA().methodA(); // åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œ
        }
    }

è¾“å‡ºï¼š
methodA in thread: main
methodB in thread: main
methodC in thread: main

è™½ç„¶è¿™ä¸‰ä¸ªæ–¹æ³• åˆ†åˆ«å±äº ServiceAã€ServiceB å’Œ Utilsï¼Œä½†å®ƒä»¬éƒ½ åœ¨ åŒä¸€ä¸ªçº¿ç¨‹ï¼ˆmain çº¿ç¨‹ï¼‰ ä¸­æ‰§è¡Œã€‚
è¿™å°±æ˜¯â€œåŒä¸€ä¸ªçº¿ç¨‹ä¸­çš„ä¸åŒæ–¹æ³•â€ã€‚

===
äºŒã€è¿™å’Œâ€œç±»ä¸­çš„ä¸åŒæ–¹æ³•â€æ˜¯ä¸€å›äº‹å—ï¼Ÿ
ä¸æ˜¯ä¸€å›äº‹ï¼

å¯¹æ¯”ç»´åº¦	        | åŒä¸€ä¸ªçº¿ç¨‹ä¸­çš„ä¸åŒæ–¹æ³•   |	ç±»ä¸­çš„ä¸åŒæ–¹æ³•
å…³æ³¨ç‚¹	        | æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆçº¿ç¨‹ï¼‰	    | ä»£ç ç»„ç»‡ç»“æ„ï¼ˆç±»ï¼‰
æ˜¯å¦å¿…é¡»åŒä¸€çº¿ç¨‹ï¼Ÿ	| æ˜¯	                | å¦ï¼ˆç±»çš„æ–¹æ³• å¯ä»¥ åœ¨ä¸åŒçº¿ç¨‹ä¸­ è¢«è°ƒç”¨ï¼‰
æ˜¯å¦å¿…é¡»åŒä¸€ç±»ï¼Ÿ	| å¦ï¼ˆå¯ä»¥è·¨ç±»ï¼‰          | æ˜¯
ä¸¾ä¾‹	            | Aç±»çš„m1 â†’ Bç±»çš„m2 â†’ Cç±»çš„m3ï¼ˆéƒ½åœ¨Thread-1ä¸­ï¼‰|	Aç±»çš„m1ã€m2ã€m3ï¼ˆå¯èƒ½è¢«å¤šä¸ªçº¿ç¨‹è°ƒç”¨ï¼‰

==
âŒ åä¾‹è¯´æ˜ï¼š

public class Counter {
    public void increment() { /* ... */ }
    public void decrement() { /* ... */ }
}
â‘  increment() å’Œ decrement() æ˜¯ åŒä¸€ä¸ªç±»ä¸­çš„ä¸åŒæ–¹æ³•ã€‚
â‘¡ ä½†å¦‚æœçº¿ç¨‹ T1 è°ƒç”¨ increment()ï¼Œçº¿ç¨‹ T2 è°ƒç”¨ decrement()ï¼Œé‚£ä¹ˆå®ƒä»¬å°±ä¸åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­ï¼
æ‰€ä»¥ï¼Œâ€œç±»ä¸­çš„ä¸åŒæ–¹æ³•â€ â‰  â€œåŒä¸€ä¸ªçº¿ç¨‹ä¸­çš„ä¸åŒæ–¹æ³•â€ã€‚

===
ä¸‰ã€ä¸ºä»€ä¹ˆè¿™ä¸ªåŒºåˆ« å¯¹ ThreadLocal å¾ˆé‡è¦ï¼Ÿ
å› ä¸º ThreadLocal çš„æ ¸å¿ƒä½œç”¨æ˜¯ï¼šåœ¨ åŒä¸€ä¸ªçº¿ç¨‹ å†…ï¼Œè·¨æ–¹æ³• å…±äº«æ•°æ®ï¼Œè€Œæ— éœ€ é€šè¿‡å‚æ•°ä¼ é€’ã€‚

æ¯”å¦‚ï¼š

    private static ThreadLocal<String> userId = new ThreadLocal<>();

    public void handleRequest(String user) {
        userId.set(user);     // è®¾ç½®å½“å‰çº¿ç¨‹çš„ç”¨æˆ·ID
        validate();           // æ–¹æ³•1ï¼šä¸éœ€è¦ä¼ å‚å°±èƒ½æ‹¿åˆ° userId
        process();            // æ–¹æ³•2ï¼šåŒæ ·èƒ½æ‹¿åˆ°
        log();                // æ–¹æ³•3ï¼šä¹Ÿèƒ½æ‹¿åˆ°
        userId.remove();      // æ¸…ç†
    }

    private void validate() {
        String u = userId.get(); // âœ… èƒ½å–åˆ°ï¼Œå› ä¸ºæ˜¯åŒä¸€çº¿ç¨‹
        System.out.println("Validating for: " + u);
    }

    private void process() {
        String u = userId.get(); // âœ… åŒæ ·èƒ½å–åˆ°
        // ...
    }
è¿™é‡Œ handleRequestã€validateã€processã€log å¯èƒ½ åˆ†å¸ƒåœ¨ä¸åŒç±»ä¸­ï¼Œä½†åªè¦å®ƒä»¬ åœ¨ åŒä¸€ä¸ªè¯·æ±‚çº¿ç¨‹ ä¸­ è¢«è°ƒç”¨ï¼Œ
å°±èƒ½é€šè¿‡ ThreadLocal å…±äº« userIdã€‚

===
æ€»ç»“
âœ… â€œåŒä¸€ä¸ªçº¿ç¨‹ä¸­çš„ä¸åŒæ–¹æ³•â€ å¼ºè°ƒçš„æ˜¯ æ‰§è¡Œæ—¶çš„ çº¿ç¨‹ä¸Šä¸‹æ–‡ ç›¸åŒï¼Œä¸ æ–¹æ³•å±äºå“ªä¸ªç±» æ— å…³ã€‚
âŒ â€œç±»ä¸­çš„ä¸åŒæ–¹æ³•â€ åªæ˜¯ ä»£ç ç»“æ„ä¸Šçš„åˆ’åˆ†ï¼Œä¸æ¶‰åŠ çº¿ç¨‹ä¸Šä¸‹æ–‡ã€‚
ğŸ”‘ ThreadLocal åˆ©ç”¨çš„æ˜¯ çº¿ç¨‹ä¸Šä¸‹æ–‡ï¼Œè€Œä¸æ˜¯ ç±»ç»“æ„ã€‚