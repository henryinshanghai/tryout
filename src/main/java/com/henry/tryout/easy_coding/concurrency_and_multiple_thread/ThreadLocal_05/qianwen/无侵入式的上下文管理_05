ä»€ä¹ˆå«åšæ— ä¾µå…¥å¼ä¸Šä¸‹æ–‡ç®¡ç†ï¼Ÿä½ èƒ½å…·ä½“è¯´ä¸€ä¸‹ æ€ä¹ˆç»“åˆæ‹¦æˆªå™¨/è¿‡æ»¤å™¨ è‡ªåŠ¨å®Œæˆsetå’Œclearå—ï¼Ÿ

===
ä¸€ã€ä»€ä¹ˆæ˜¯â€œæ— ä¾µå…¥å¼ä¸Šä¸‹æ–‡ç®¡ç†â€ï¼Ÿ
ğŸ“Œ æ ¸å¿ƒæ€æƒ³ï¼š
åœ¨ ä¸ä¿®æ”¹ä¸šåŠ¡ä»£ç  çš„å‰æä¸‹ï¼Œè‡ªåŠ¨å®Œæˆ çº¿ç¨‹ä¸Šä¸‹æ–‡ï¼ˆå¦‚ç”¨æˆ·IDã€è¯·æ±‚IDç­‰ï¼‰çš„æ³¨å…¥ä¸æ¸…ç†ã€‚

â‘  â€œæ— ä¾µå…¥â€ æ„å‘³ç€ï¼šä½ çš„ä¸šåŠ¡æ–¹æ³•ï¼ˆControllerã€Service ç­‰ï¼‰ ä¸éœ€è¦å…³å¿ƒ ä¸Šä¸‹æ–‡ ä»å“ªæ¥ã€æ€ä¹ˆè®¾ç½®ã€è¦ä¸è¦æ¸…ç†ã€‚
â‘¡ ä¸Šä¸‹æ–‡çš„ç”Ÿå‘½å‘¨æœŸ ç”± æ¡†æ¶ï¼ˆå¦‚ Web å®¹å™¨ï¼‰åœ¨ è¯·æ±‚å¼€å§‹ æ—¶ è‡ªåŠ¨è®¾ç½®ï¼Œåœ¨ è¯·æ±‚ç»“æŸ æ—¶ è‡ªåŠ¨æ¸…é™¤ã€‚
â‘¢ è¿™æ˜¯ä¸€ç§å…¸å‹çš„ AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰   æ€æƒ³ï¼šå°† â€œæ¨ªåˆ‡å…³æ³¨ç‚¹â€ ï¼ˆå¦‚ è®¤è¯ã€æ—¥å¿—ã€ä¸Šä¸‹æ–‡ï¼‰ä¸ æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ åˆ†ç¦»ã€‚

===
äºŒã€ä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ
å‡è®¾ä½ æœ‰ä¸€ä¸ª Web æ¥å£ï¼š

    @GetMapping("/profile")
    public String getProfile(String userId) {
        // ä¸šåŠ¡é€»è¾‘...
    }

å¦‚æœ æ¯ä¸ªæ–¹æ³•éƒ½è¦ æ‰‹åŠ¨ä¼  userIdï¼Œä¸ä»… å†—ä½™ï¼Œè¿˜ å®¹æ˜“å‡ºé”™ã€‚
è€Œå¦‚æœä½ ç”¨ ThreadLocal æ‰‹åŠ¨ set/get/removeï¼Œåˆ å®¹æ˜“å¿˜è®° removeï¼Œå¯¼è‡´ å†…å­˜æ³„æ¼ æˆ– æ•°æ®æ±¡æŸ“ã€‚

âœ… æ— ä¾µå…¥å¼æ–¹æ¡ˆï¼šè®© æ¡†æ¶ å¸®ä½ æå®šä¸€åˆ‡ï¼Œä¸šåŠ¡ä»£ç  åªå†™ æ ¸å¿ƒé€»è¾‘ï¼

===
ä¸‰ã€å…·ä½“å®ç°ï¼šä»¥ Spring Boot + æ‹¦æˆªå™¨ä¸ºä¾‹
æˆ‘ä»¬å°†å®ç°ï¼šä» HTTP Header ä¸­ æå– ç”¨æˆ·IDï¼Œè‡ªåŠ¨å­˜å…¥ ThreadLocalï¼Œå¹¶ åœ¨è¯·æ±‚ç»“æŸå è‡ªåŠ¨æ¸…ç†ã€‚

æ­¥éª¤ 1ï¼šå®šä¹‰ ä¸Šä¸‹æ–‡å·¥å…·ç±»
// UserContext.java
public class UserContext {
    private static final ThreadLocal<String> CURRENT_USER_ID = new ThreadLocal<>();

    public static void setUserId(String userId) {
        CURRENT_USER_ID.set(userId);
    }

    public static String getUserId() {
        return CURRENT_USER_ID.get();
    }

    public static void clear() {
        CURRENT_USER_ID.remove(); // âš ï¸ éå¸¸å…³é”®ï¼
    }
}
ä½¿ç”¨ private static final ç¡®ä¿ å…¨å±€å”¯ä¸€ ä¸” å®‰å…¨ã€‚

==
æ­¥éª¤ 2ï¼šåˆ›å»º æ‹¦æˆªå™¨ï¼ˆInterceptorï¼‰

// UserContextInterceptor.java
import org.springframework.stereotype.Component;
import org.springframework.web.servlet.HandlerInterceptor;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@Component
public class UserContextInterceptor implements HandlerInterceptor {

    @Override
    public boolean preHandle(HttpServletRequest request,
                             HttpServletResponse response,
                             Object handler) throws Exception {
        // 1. ä» Header ä¸­ è·å– ç”¨æˆ·æ ‡è¯†ï¼ˆä¾‹å¦‚ï¼šX-User-IDï¼‰
        String userId = request.getHeader("X-User-ID");

        // 2. å¦‚æœ å­˜åœ¨ï¼Œåˆ™ å­˜å…¥ ThreadLocal
        if (userId != null && !userId.trim().isEmpty()) {
            UserContext.setUserId(userId);
        }

        return true; // ç»§ç»­æ‰§è¡Œ Controller
    }

    @Override
    public void afterCompletion(HttpServletRequest request,
                                HttpServletResponse response,
                                Object handler,
                                Exception ex) throws Exception {
        // 3. ã€å…³é”®ã€‘è¯·æ±‚å¤„ç†å®Œæ¯•åï¼Œæ¸…ç† ThreadLocal
        UserContext.clear();
    }
}
âœ… preHandleï¼šåœ¨è¯·æ±‚å‰ è®¾ç½®ä¸Šä¸‹æ–‡
âœ… afterCompletionï¼šåœ¨è¯·æ±‚å æ¸…ç†ï¼ˆæ— è®ºæˆåŠŸ/å¼‚å¸¸éƒ½ä¼šæ‰§è¡Œï¼‰

===
æ­¥éª¤ 3ï¼šæ³¨å†Œæ‹¦æˆªå™¨

// WebConfig.java
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebConfig implements WebMvcConfigurer {

    private final UserContextInterceptor userContextInterceptor;

    public WebConfig(UserContextInterceptor userContextInterceptor) {
        this.userContextInterceptor = userContextInterceptor;
    }

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(userContextInterceptor)
                .addPathPatterns("/**")          // æ‹¦æˆª æ‰€æœ‰è·¯å¾„
                .excludePathPatterns("/public/**"); // å¯é€‰ï¼šæ’é™¤ å…¬å¼€æ¥å£
    }
}

===
æ­¥éª¤ 4ï¼šä¸šåŠ¡ä»£ç  å®Œå…¨â€œæ— æ„ŸçŸ¥â€

// ProfileController.java
@RestController
public class ProfileController {

    @GetMapping("/profile")
    public String getProfile() {
        // ç›´æ¥è·å– å½“å‰ç”¨æˆ·IDï¼Œæ— éœ€ å‚æ•°ä¼ é€’ï¼
        String userId = UserContext.getUserId();
        if (userId == null) {
            throw new RuntimeException("æœªç™»å½•");
        }
        return "Hello, user " + userId;
    }
}
ğŸ”¥ ä½ çœ‹ï¼šController é‡Œ æ²¡æœ‰ä»»ä½• è®¾ç½®/æ¸…ç†é€»è¾‘ï¼Œä½† userId å§‹ç»ˆå¯ç”¨ï¼

===
å››ã€å¦‚æœæ˜¯ç”¨ Filterï¼ˆæ›´åº•å±‚ï¼‰ï¼Ÿ
å¦‚æœ ä½ ä¸ä½¿ç”¨ Spring MVCï¼Œæˆ–è€…æƒ³ åœ¨ æ›´æ—©é˜¶æ®µ å¤„ç†ï¼ˆæ¯”å¦‚åœ¨ Security ä¹‹å‰ï¼‰ï¼Œå¯ä»¥ç”¨ Servlet Filterï¼š

@WebFilter("/*")
public class UserContextFilter implements Filter {
    @Override
    public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain)
            throws IOException, ServletException {
        HttpServletRequest request = (HttpServletRequest) req;
        String userId = request.getHeader("X-User-ID");

        try {
            if (userId != null) {
                UserContext.setUserId(userId);
            }
            chain.doFilter(req, res); // ç»§ç»­
        } finally {
            UserContext.clear(); // å¿…é¡»æ”¾åœ¨ finallyï¼
        }
    }
}


åœ¨ Spring Boot ä¸­æ³¨å†Œï¼š
@Bean
public FilterRegistrationBean<UserContextFilter> userContextFilter() {
    FilterRegistrationBean<UserContextFilter> bean = new FilterRegistrationBean<>();
    bean.setFilter(new UserContextFilter());
    bean.addUrlPatterns("/*");
    return bean;
}

===
äº”ã€ä¸ºä»€ä¹ˆå¿…é¡»è‡ªåŠ¨ clearï¼Ÿ
å› ä¸º Webåº”ç”¨ é€šå¸¸ ä½¿ç”¨çº¿ç¨‹æ± ï¼ˆå¦‚ Tomcat çš„å·¥ä½œçº¿ç¨‹æ± ï¼‰ï¼š

â‘  è¯·æ±‚A ä½¿ç”¨ çº¿ç¨‹ T1ï¼Œè®¾ç½® userId = "alice"
â‘¡ è¯·æ±‚ç»“æŸåï¼Œå¦‚æœ ä¸clearï¼ŒT1çº¿ç¨‹ è¢«å›æ”¶åˆ°æ± ä¸­
â‘¢ ä¸‹ä¸€ä¸ªè¯·æ±‚B æ°å¥½ ä¹Ÿåˆ†é…åˆ° T1ï¼Œè°ƒç”¨UserContext.getUserId() â†’ å¾—åˆ° "alice"ï¼ˆå…¶å®æ˜¯ ä¸Šä¸€ä¸ªç”¨æˆ·çš„ï¼ï¼‰
ğŸ’¥ è¿™ä¼šå¯¼è‡´ ä¸¥é‡çš„æ•°æ®æ³„éœ² å’Œ å®‰å…¨é—®é¢˜ï¼

âœ… æ‰€ä»¥ï¼šclear() ä¸æ˜¯å¯é€‰é¡¹ï¼Œè€Œæ˜¯å¿…é¡»é¡¹ï¼

===
å…­ã€æ€»ç»“ï¼šæ— ä¾µå…¥å¼ ä¸Šä¸‹æ–‡ç®¡ç†çš„å…³é”®ç‚¹
è¦ç´ 	            | è¯´æ˜
æ— ä¾µå…¥	        | ä¸šåŠ¡ä»£ç ä¸å†™ set/removeï¼Œåªè°ƒç”¨ get
è‡ªåŠ¨ set	        | åœ¨ è¯·æ±‚å…¥å£ï¼ˆFilter/Interceptorï¼‰è§£æå¹¶è®¾ç½®
è‡ªåŠ¨ clear	    | åœ¨ è¯·æ±‚å‡ºå£ï¼ˆfinally / afterCompletionï¼‰æ¸…ç†
ThreadLocal å®šä¹‰	| private static final + å°è£…è®¿é—®æ–¹æ³•
é€‚ç”¨åœºæ™¯	        | ç”¨æˆ·èº«ä»½ã€traceIdã€ç§Ÿæˆ·IDã€è¯­è¨€ç¯å¢ƒç­‰

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ çš„ç³»ç»Ÿ æ—¢å®‰å…¨ åˆæ•´æ´ï¼ŒçœŸæ­£åšåˆ°äº† â€œé«˜å†…èšã€ä½è€¦åˆâ€ã€‚

