--- DispatcherServletçš„å¯åŠ¨ ---
factï¼š ä½œä¸ºä¸€ä¸ªServletï¼Œ DispatcherServletçš„å¯åŠ¨ ä¸ Servletçš„å¯åŠ¨è¿‡ç¨‹æ˜¯ç›¸å…³è”çš„ã€‚

-- Servletçš„åˆå§‹åŒ– --
æ‰‹æ®µï¼šè°ƒç”¨ Servletçš„init()æ–¹æ³•ï¼›

-- DispatcherServletçš„åŸºç±» HttpServletBeanç±»çš„åˆå§‹åŒ–æ–¹æ³• --
- org.springframework.web.servlet.HttpServletBean.init() -
ä½œç”¨ï¼šæŠŠæ‰€é…ç½®çš„å‚æ•° æ˜ å°„åˆ° å½“å‰servletçš„beanå±æ€§ä¸Šå»ï¼Œå¹¶ è°ƒç”¨å­ç±»çš„åˆå§‹åŒ–æ–¹æ³•ï¼›
æ­¥éª¤ï¼š
    #1 åœ¨åˆå§‹åŒ–å¼€å§‹æ—¶ï¼Œéœ€è¦è¯»å– é…ç½®åœ¨ServletContextä¸­çš„Beanå±æ€§å‚æ•°ï¼›
        ç‰¹å¾ï¼š
            #1 è¿™äº›ä¸ªå‚æ•°é…ç½®åœ¨ web.xmlæ–‡ä»¶ å…³äº Webå®¹å™¨åˆå§‹åŒ–å‚æ•°çš„éƒ¨åˆ†ã€‚
            #2 å¼€å‘è€…å¯ä»¥ä½¿ç”¨ç¼–å†™ä»£ç çš„æ–¹å¼ æ¥ è·å–åˆ°é…ç½®åœ¨web.xmlæ–‡ä»¶ä¸­çš„ç›¸å…³å±æ€§ï¼›
                PropertyValues pvs = ...  BeanWrapper bw = ...
                ğŸ– åœ¨åˆ†æIoCå®¹å™¨çš„åˆå§‹åŒ– / å¯¹ä¾èµ–æ³¨å…¥çš„å®ç°è¿›è¡Œåˆ†ææ—¶ï¼Œå…¶å®å°±æ¶‰åŠåˆ°äº†è¿™äº›ä¸ª â€œä¸ä¾èµ–æ³¨å…¥ç›¸å…³çš„ç±»â€
            #3 æ­¤å¤„çš„ä¾èµ–æ³¨å…¥ ä¸ Webå®¹å™¨çš„åˆå§‹åŒ–ç›¸å…³ï¼Œå› æ­¤ åˆå§‹åŒ–è¿‡ç¨‹ ç”± HttpServletBeanæ¥å®Œæˆã€‚
    #2 è¿›è¡Œ DispatcherServletæ‰€æŒæœ‰çš„IoCå®¹å™¨çš„åˆå§‹åŒ–ï¼›
        ä½œç”¨ï¼šç”±æ­¤å»ºç«‹äº†ä¸€ä¸ªå…¨æ–°çš„ä¸Šä¸‹æ–‡ B - è¿™ä¸ªä¸Šä¸‹æ–‡B ä¼šè¢«è®¾ç½®ä¸º æ ¹ä¸Šä¸‹æ–‡Açš„å­ä¸Šä¸‹æ–‡ã€‚
            æ ¹ä¸Šä¸‹æ–‡ï¼šå±äº Webåº”ç”¨ï¼›
            DispatcherServletæ‰€æŒæœ‰çš„ä¸Šä¸‹æ–‡ï¼š å±äº Servletï¼›
            factï¼š
                #1 åœ¨ä¸€ä¸ªWebåº”ç”¨ä¸­ï¼Œ ä¸€èˆ¬å¯ä»¥å®¹çº³å¤šä¸ª Servletçš„å­˜åœ¨ï¼›
                #2 åœ¨Webå®¹å™¨ä¸­ï¼Œä¸€ä¸ª"æ ¹ä¸Šä¸‹æ–‡" èƒ½å¤Ÿä½œä¸º å¾ˆå¤šä¸ª "servletä¸Šä¸‹æ–‡"çš„ â€œåŒäº²ä¸Šä¸‹æ–‡â€ï¼›

            -- æ‰©å±•ï¼š åœ¨Webç¯å¢ƒçš„IoCå®¹å™¨ä¸­ï¼Œè®¾ç½®ä¸æ£€ç´¢ Bean --
            factï¼šå¼€å‘è€…å‘ IoCå®¹å™¨å» getBeanæ—¶ï¼ŒIoCå®¹å™¨ä¼šé¦–å…ˆ å‘å®ƒçš„â€œåŒäº²ä¸Šä¸‹æ–‡â€æ¥ è·å–Beanã€‚
            ç»¼ä¸Šï¼Œ åœ¨æ ¹ä¸Šä¸‹æ–‡ä¸­æ‰€å®šä¹‰çš„Bean èƒ½å¤Ÿ è¢«æ‰€æœ‰çš„Servletä¸Šä¸‹æ–‡ å…±äº«/è·å–ã€‚
    #3 DispatcherServletæ‰€æŒæœ‰çš„ä¸Šä¸‹æ–‡å»ºç«‹å®Œæˆåï¼Œè¿›è¡Œå®¹å™¨çš„åˆå§‹åŒ– - å»ºç«‹å®Œæˆæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ
        æ‰‹æ®µï¼šrefresh()æ–¹æ³•ï¼›
    #4 ç»™è‡ªå·±æ‰€æŒæœ‰çš„ä¸Šä¸‹æ–‡è¿›è¡Œå‘½åï¼Œå¹¶ æŠŠè¿™ä¸ªä¸Šä¸‹æ–‡ è®¾ç½®åˆ° Webå®¹å™¨çš„ä¸Šä¸‹æ–‡ï¼ˆServletContextï¼‰ä¸­ï¼›
        ğŸ– #4ä¸­çš„åç§° ä¸ å¼€å‘è€…åœ¨web.xmlä¸­ä¸ºDispatcherServletæ‰€è®¾ç½®çš„ â€œServletåç§°â€æœ‰å…³ã€‚
        ä½œç”¨ï¼šç”¨äº ä¿è¯ DSæ‰€æŒæœ‰çš„ä¸Šä¸‹æ–‡ åœ¨Webç¯å¢ƒä¸Šä¸‹æ–‡ç³»ç»Ÿä¸­çš„å”¯ä¸€æ€§ã€‚

ä»£ç åˆ†æï¼š
#1 HttpServletBean init()
// è·å–Servletçš„åˆå§‹åŒ–å‚æ•°ï¼Œç”¨æ¥è®¾ç½® Beançš„å±æ€§
PropertyValues pvs = ...

#2 HttpServletBean
// å…è®¸å­ç±»åšè‡ªå·±æƒ³è¦çš„åˆå§‹åŒ– - è°ƒç”¨å­ç±»çš„initServletBean()æ¥è¿›è¡Œå…·ä½“çš„åˆå§‹åŒ–
initServletBean();

#3 FrameworkServlet
-- org.springframework.web.servlet.FrameworkServlet.initServletBean() --
è¦†å†™ HttpServletBeançš„æ–¹æ³•ï¼Œåœ¨ä»»ä½•Beanå±æ€§è¢«è®¾ç½®åå°±ä¼šè¢«è°ƒç”¨ã€‚
ç”¨äºåˆ›å»ºå½“å‰Servletçš„ WebApplicationContext

#4 å¯¹ä¸Šä¸‹æ–‡è¿›è¡Œåˆå§‹åŒ–
this.webApplicationContext = initWebApplicationContext();

#5 è·å–åˆ°æ ¹ä¸Šä¸‹æ–‡
// è°ƒç”¨ WebApplicationContextUtilsé™æ€ç±» æ¥ å¾—åˆ°æ ¹ä¸Šä¸‹æ–‡
// è¿™ä¸ªæ ¹ä¸Šä¸‹æ–‡æ˜¯ä¿å­˜åœ¨ ServletContextä¸­çš„
// ä½¿ç”¨è¿™ä¸ªæ ¹ä¸Šä¸‹æ–‡ ä½œä¸º å½“å‰MVCä¸Šä¸‹æ–‡çš„ åŒäº²ä¸Šä¸‹æ–‡(parent context)
WebApplicationContext rootContext =
        WebApplicationContextUtils.getWebApplicationContext(getServletContext());

#6 è·å–åˆ° å½“å‰Servletçš„ä¸Šä¸‹æ–‡ magically?
// åœ¨æ„å»ºæ—¶ ä¸€ä¸ªä¸Šä¸‹æ–‡å®ä¾‹è¢«æ³¨å…¥ -> ä½¿ç”¨å®ƒ
wac = this.webApplicationContext;

#7 æŠŠ webåº”ç”¨çš„æ ¹ä¸Šä¸‹æ–‡ è®¾ç½®ä¸º servletçš„ä¸Šä¸‹æ–‡ çš„ parent
// æŠŠå½“å‰å»ºç«‹çš„ä¸Šä¸‹æ–‡å­˜åˆ° ServletContextä¸­å»
// æ³¨æ„è¿™é‡Œä½¿ç”¨çš„å±æ€§å æ˜¯å’Œå½“å‰Servletåç›¸å…³çš„
if (this.publishContext) {...}

è‡³æ­¤ï¼ŒMVCçš„ä¸Šä¸‹æ–‡å°±å»ºç«‹èµ·æ¥äº†ã€‚

-- è·å–åˆ°æ ¹ä¸Šä¸‹æ–‡çš„è¿‡ç¨‹ --
WebApplicationContextUtils.getWebApplicationContext(getServletContext());

// æŸ¥æ‰¾åˆ°å½“å‰web appçš„ æ ¹ä¸Šä¸‹æ–‡ï¼Œé€šå¸¸æƒ…å†µä¸‹ ä¼šé€šè¿‡ org.springframework.web.context.ContextLoaderListener æ¥åŠ è½½
public static WebApplicationContext getWebApplicationContext(ServletContext sc) {
    // ğŸ– è¿™ä¸ªå±æ€§æ‰€ä»£è¡¨çš„ æ ¹ä¸Šä¸‹æ–‡ åœ¨ContextLoaderListeneråˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ è¢«å»ºç«‹ï¼Œå¹¶è¢«è®¾ç½®åˆ° ServletContextä¸­
    return getWebApplicationContext(sc, WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE);
}

#1 è¿™ä¸ªæ ¹ä¸Šä¸‹æ–‡ ä¼šé€šè¿‡ ContextLoader æ¥ è®¾ç½®åˆ° ServletContextä¸­å»ï¼›
    è®¾ç½®æ—¶æ‰€ä½¿ç”¨çš„å±æ€§åæ˜¯ ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTEï¼›
#2 ContextLoader è¿˜ä¼šå¯¹ æ­¤IoCå®¹å™¨çš„Beané…ç½®æ–‡ä»¶è¿›è¡Œè®¾ç½® - Beané…ç½®æ–‡ä»¶é»˜è®¤çš„ä½ç½®æ˜¯ /WEB-INF/applicationContext.xmlï¼›
#3 å› ä¸º#1ä¸­çš„æ ¹ä¸Šä¸‹æ–‡æ˜¯ DispatcherServletæ‰€å»ºç«‹èµ·çš„ä¸Šä¸‹æ–‡çš„ â€œåŒäº²ä¸Šä¸‹æ–‡â€ï¼Œæ‰€ä»¥ï¼š
    æ ¹ä¸Šä¸‹æ–‡æ‰€ç®¡ç†çš„Bean ä¹Ÿå¯ä»¥ è¢« DispatcherServletçš„ä¸Šä¸‹æ–‡ ç›´æ¥ä½¿ç”¨ã€‚

fact: ä½¿ç”¨getBean å‘IoCå®¹å™¨è·å–Beanæ—¶ï¼Œå®¹å™¨ä¼šå…ˆåˆ°è‡ªå·±çš„ â€œåŒäº²IoCå®¹å™¨â€ä¸­getBeanã€‚
